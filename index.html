<!doctype html>
<html>
  <!-- https://doc.babylonjs.com/setup/starterHTML -->
  
  <head>
    <title>Infinite Voxel Test</title>
    
    <style>
      html, body {
        overflow: hidden;
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
      }
      
      #canvas {
        width: 100%;
        height: 100%;
      }
    </style>
    
    <script src = 'lib_extern/babylon_6.46.0.js'></script>
  </head>
  
  <body>
    <canvas id = 'canvas'></canvas>
    
    <script>
      let MOVEMENT_SPEED = 1;
      
      const KEY_CODES = {
        ShiftLeft: 16,
        KeyA: 65,
        KeyD: 68,
        KeyS: 83,
        KeyW: 87,
        KeyZ: 90,
      };
      
      const engine = new BABYLON.Engine(canvas, true);
      
      function createScene() {
        const scene = new BABYLON.Scene(engine);
        
        const camera = new BABYLON.UniversalCamera('camera', new BABYLON.Vector3(0, 5, -10), scene);
        
        camera.setTarget(BABYLON.Vector3.Zero());
        camera.inertia = 0;
        camera.angularSensibility = 500;
        
        camera.attachControl();
        
        const light = new BABYLON.HemisphericLight('light', new BABYLON.Vector3(0, 1, 0), scene);
        
        light.intensity = 0.7;
        
        const sphere = BABYLON.MeshBuilder.CreateSphere('sphere', { diameter: 2, segments: 10 }, scene);
        
        sphere.position.y = 1;
        
        const ground = BABYLON.MeshBuilder.CreateGround('ground', { width: 6, height: 6 }, scene);
        
        scene.onPointerDown = () => {
          // https://github.com/il-m-yamagishi/babylon-fps-shooter/blob/main/src/MainScene.ts#L107
          if (!engine.isPointerLock) {
            engine.enterPointerlock();
          }
        };
        
        // https://playground.babylonjs.com/#H5813K
        const dsm = new BABYLON.DeviceSourceManager(engine);
        
        scene.beforeRender = () => {
          const keyboard = dsm.getDeviceSource(BABYLON.DeviceType.Keyboard);
          
          if (keyboard) {
            if (keyboard.getInput(KEY_CODES.KeyW)) {
              // https://forum.babylonjs.com/t/how-to-move-the-camera-in-the-direction-the-camera-is-facing/21307
              // https://forum.babylonjs.com/t/how-to-use-delta-time/27501
              camera.position = camera.getFrontPosition(MOVEMENT_SPEED * scene.deltaTime / 1000);
            }
          }
        };
        
        return scene;
      }
      
      const scene = createScene();
      
      engine.runRenderLoop(() => {
        scene.render();
      });
      
      addEventListener('resize', () => engine.resize());
    </script>
  </body>
</html>
